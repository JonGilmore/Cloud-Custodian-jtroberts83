{
   "account":"awsaus",
   "account_id":"XXXXXXXXXX",
   "region":"us-west-1",
   "action":{
      "violation_desc":"Public IP Address:",
      "to":[
         "Custodian@Company.com",
         "event-owner"
      ],
      "action_desc":"Actions Taken:  The EC2 Instance Has Been Terminated",
      "template":"default.html",
      "subject":"EC2 - Public IP Terminated - [custodian {{ account }} - {{ region }}]",
      "type":"notify",
      "transport":{
         "queue":"https://sqs.us-east-1.amazonaws.com/XXXXXXXXXX/cloud-custodian-mailer",
         "region":"us-east-1",
         "type":"sqs"
      },
      "priority_header":1
   },
   "policy":{
      "resource":"ec2",
      "name":"no-ec2-public-ips",
      "actions":[
         {
            "force":true,
            "type":"terminate"
         },
         {
            "violation_desc":"Public IP Address:",
            "to":[
               "Custodian@Company.com",
               "event-owner"
            ],
            "action_desc":"Actions Taken:  The EC2 Instance Has Been Terminated",
            "template":"default.html",
            "priority_header":1,
            "type":"notify",
            "transport":{
               "queue":"https://sqs.us-east-1.amazonaws.com/XXXXXXXXXX/cloud-custodian-mailer",
               "region":"us-east-1",
               "type":"sqs"
            },
            "subject":"EC2 - Public IP Terminated - [custodian {{ account }} - {{ region }}]"
         }
      ],
      "comments":"If a EC2 instance is launched with a public IP attached initially\nit will get terminated unless its aviatrix and Notification sent.\n",
      "filters":[
         {
            "type":"event",
            "value":true,
            "key":"detail.requestParameters.networkInterfaceSet.items[0].associatePublicIpAddress"
         },
         {
            "not":[
               {
                  "type":"event",
                  "value":"^((?i)svcaviatrix(?i))",
                  "key":"detail.userIdentity.userName",
                  "op":"regex"
               }
            ]
         }
      ],
      "mode":{
         "type":"cloudtrail",
         "events":[
            "RunInstances"
         ]
      }
   },
   "event":{
      "account":"XXXXXXXXXX",
      "c7n:MatchedFilters":[
         "detail.requestParameters.networkInterfaceSet.items[0].associatePublicIpAddress"
      ],
      "region":"us-west-1",
      "detail":{
         "eventVersion":"1.05",
         "eventID":"8a69c5e2-f6aa-428e-abf5-a58cc6248e9c",
         "eventTime":"2017-07-05T15:01:41Z",
         "requestParameters":{
            "blockDeviceMapping":{
               "items":[
                  {
                     "deviceName":"/dev/xvda",
                     "ebs":{
                        "deleteOnTermination":true,
                        "volumeSize":8,
                        "volumeType":"gp2"
                     }
                  }
               ]
            },
            "monitoring":{
               "enabled":false
            },
            "networkInterfaceSet":{
               "items":[
                  {
                     "deviceIndex":0,
                     "groupSet":{
                        "items":[
                           {
                              "groupId":"sg-XXXXXXXX"
                           }
                        ]
                     },
                     "description":"Primary network interface",
                     "ipv6AddressCount":0,
                     "deleteOnTermination":true,
                     "subnetId":"subnet-XXXXXXXXXX",
                     "associatePublicIpAddress":true
                  }
               ]
            },
            "instanceInitiatedShutdownBehavior":"stop",
            "tagSpecificationSet":{
               "items":[
                  {
                     "resourceType":"instance",
                     "tags":[
                        {
                           "value":"MyName",
                           "key":"Name"
                        }
                     ]
                  },
                  {
                     "resourceType":"volume",
                     "tags":[
                        {
                           "value":"MyName",
                           "key":"Name"
                        }
                     ]
                  }
               ]
            },
            "tenancy":"default",
            "clientToken":"bNgzS14992256455669dsfdsfsdf00849",
            "instancesSet":{
               "items":[
                  {
                     "minCount":1,
                     "maxCount":1,
                     "keyName":"-DEV",
                     "imageId":"ami-cccccccc"
                  }
               ]
            },
            "disableApiTermination":false,
            "instanceType":"t2.micro",
            "ebsOptimized":false
         },
         "eventType":"AwsApiCall",
         "responseElements":{
            "ownerId":"XXXXXXXXXX",
            "groupSet":{

            },
            "reservationId":"r-0rrrrrrrrrrr",
            "requestId":"b5e09cba-71d3-3dc165472ced",
            "instancesSet":{
               "items":[
                  {
                     "productCodes":{

                     },
                     "vpcId":"vpc-abababababababa",
                     "instanceId":"i-osososososososo",
                     "imageId":"ami-aaaaaaaaaa",
                     "keyName":"-DEV",
                     "clientToken":"bNgzS14933455w9266ffff900849",
                     "subnetId":"subnet-ssssssss",
                     "amiLaunchIndex":0,
                     "instanceType":"t2.micro",
                     "groupSet":{
                        "items":[
                           {
                              "groupName":"",
                              "groupId":"sg-dgdgdgdgdg"
                           }
                        ]
                     },
                     "monitoring":{
                        "state":"disabled"
                     },
                     "stateReason":{
                        "message":"pending",
                        "code":"pending"
                     },
                     "privateIpAddress":"122.122.133.111",
                     "virtualizationType":"hvm",
                     "privateDnsName":"ip-122-122-133-111",
                     "tagSet":{
                        "items":[
                           {
                              "value":"MyName",
                              "key":"Name"
                           }
                        ]
                     },
                     "sourceDestCheck":true,
                     "blockDeviceMapping":{

                     },
                     "placement":{
                        "tenancy":"default",
                        "availabilityZone":"us-west-1a"
                     },
                     "hypervisor":"xen",
                     "networkInterfaceSet":{
                        "items":[
                           {
                              "status":"in-use",
                              "macAddress":"094:934354:d8",
                              "sourceDestCheck":true,
                              "vpcId":"vpc-aaaaaaaaa",
                              "description":"Primary network interface",
                              "ipv6AddressesSet":{

                              },
                              "networkInterfaceId":"eni-eeeeeeeee",
                              "groupSet":{
                                 "items":[
                                    {
                                       "groupName":"",
                                       "groupId":"sg-ssssssss"
                                    }
                                 ]
                              },
                              "attachment":{
                                 "status":"attaching",
                                 "deviceIndex":0,
                                 "deleteOnTermination":true,
                                 "attachmentId":"eni-attach-ddddddd",
                                 "attachTime":1499266901000
                              },
                              "tagSet":{

                              },
                              "subnetId":"subnet-sssssssss",
                              "ownerId":"XXXXXXXXXX",
                              "privateIpAddressesSet":{
                                 "item":[
                                    {
                                       "primary":true,
                                       "privateIpAddress":"122.122.133.111"
                                    }
                                 ]
                              },
                              "privateIpAddress":"122.122.133.111"
                           }
                        ]
                     },
                     "ebsOptimized":false,
                     "launchTime":1499266901000,
                     "architecture":"x86_64",
                     "instanceState":{
                        "code":0,
                        "name":"pending"
                     },
                     "rootDeviceType":"ebs",
                     "rootDeviceName":"/dev/xvda"
                  }
               ]
            }
         },
         "awsRegion":"us-west-1",
         "eventName":"RunInstances",
         "userIdentity":{
            "principalId":"PRINCIPLEID:USERSNAME",
            "accessKeyId":"DDDDDDDDDDDDDDDD",
            "sessionContext":{
               "sessionIssuer":{
                  "userName":"ROLENAME",
                  "type":"Role",
                  "arn":"arn:aws:iam::XXXXXXXXXX:role/ROLENAME",
                  "principalId":"PRINCIPLEID",
                  "accountId":"XXXXXXXXXX"
               },
               "attributes":{
                  "creationDate":"2017-07-05T14:53:31Z",
                  "mfaAuthenticated":"false"
               }
            },
            "type":"AssumedRole",
            "arn":"arn:aws:sts::XXXXXXXXXX:assumed-role/ROLENAME/USERSNAME",
            "accountId":"XXXXXXXXXX"
         },
         "eventSource":"ec2.amazonaws.com",
         "requestID":"b5e0sdsdsasdba-71d3-46d9-b108-3dc165472ced",
         "userAgent":"console.ec2.amazonaws.com",
         "sourceIPAddress":"172.2323.23.232.323"
      },
      "detail-type":"AWS API Call via CloudTrail",
      "source":"aws.ec2",
      "version":"0",
      "time":"2017-07-05T15:01:41Z",
      "debug":true,
      "id":"8ae84c00-wwwwwww-e22860b2e82e",
      "resources":[

      ]
   },
   "resources":[
      {
         "Monitoring":{
            "State":"disabled"
         },
         "PublicDnsName":"",
         "State":{
            "Code":16,
            "Name":"running"
         },
         "EbsOptimized":false,
         "LaunchTime":"2017-07-05T15:01:41+00:00",
         "PublicIpAddress":"IP",
         "PrivateIpAddress":"IP",
         "ProductCodes":[

         ],
         "VpcId":"vpc-vvvvvvv",
         "StateTransitionReason":"",
         "InstanceId":"i-ddddddddddd",
         "EnaSupport":true,
         "ImageId":"ami-sssssssssss",
         "PrivateDnsName":"ip-ip-ip-ip.com",
         "KeyName":"-DEV",
         "SecurityGroups":[
            {
               "GroupName":"",
               "GroupId":"sg-fffffffff"
            }
         ],
         "ClientToken":"asdasdasdasdasd",
         "SubnetId":"subnet-ssssssss",
         "InstanceType":"t2.micro",
         "NetworkInterfaces":[
            {
               "Status":"in-use",
               "MacAddress":"0MAC",
               "SourceDestCheck":true,
               "VpcId":"vpc-ddddddd",
               "Description":"Primary network interface",
               "Association":{
                  "PublicIp":"IP",
                  "PublicDnsName":"",
                  "IpOwnerId":"amazon"
               },
               "NetworkInterfaceId":"eni-sssssssss",
               "PrivateIpAddresses":[
                  {
                     "Association":{
                        "PublicIp":"IP",
                        "PublicDnsName":"",
                        "IpOwnerId":"amazon"
                     },
                     "Primary":true,
                     "PrivateIpAddress":"IP"
                  }
               ],
               "Ipv6Addresses":[

               ],
               "Attachment":{
                  "Status":"attached",
                  "DeviceIndex":0,
                  "DeleteOnTermination":true,
                  "AttachmentId":"eni-attach-dsdsdsdsdsdsd",
                  "AttachTime":"2017-07-05T15:01:41+00:00"
               },
               "Groups":[
                  {
                     "GroupName":"",
                     "GroupId":"sg-sdsdsdsdsdsd"
                  }
               ],
               "SubnetId":"subnet-sdsdsdsdsdsd",
               "OwnerId":"XXXXXXXXXX",
               "PrivateIpAddress":"IP"
            }
         ],
         "SourceDestCheck":true,
         "Placement":{
            "Tenancy":"default",
            "GroupName":"",
            "AvailabilityZone":"us-west-1a"
         },
         "Hypervisor":"xen",
         "BlockDeviceMappings":[
            {
               "DeviceName":"/dev/xvda",
               "Ebs":{
                  "Status":"attached",
                  "DeleteOnTermination":true,
                  "VolumeId":"vol-sdsdsdsdsdsdsdsdsdsd",
                  "AttachTime":"2017-07-05T15:01:42+00:00"
               }
            }
         ],
         "Architecture":"x86_64",
         "RootDeviceType":"ebs",
         "RootDeviceName":"/dev/xvda",
         "VirtualizationType":"hvm",
         "Tags":[
            {
               "Value":"Name",
               "Key":"Name"
            }
         ],
         "AmiLaunchIndex":0
      }
   ]
}
